<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simple Chat</title>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, addDoc, collection, onSnapshot, query, orderBy, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
 apiKey:"AIzaSyCufn5lJsYRhTyMpOSJL3o0AjUlGFgBdI8",
 authDomain:"simple-chat-77c11.firebaseapp.com",
 projectId:"simple-chat-77c11"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const DEV_USERS = ["jack","jacob"];
let me, myUsername, currentChat, isDev=false;

window.login=()=>signInWithPopup(auth,new GoogleAuthProvider());

onAuthStateChanged(auth, async user=>{
 if(!user) return;
 me=user;
 let snap=await getDoc(doc(db,"users",me.uid));
 if(!snap.exists()){
  myUsername=prompt("Create username").toLowerCase();
  await setDoc(doc(db,"users",me.uid),{username:myUsername});
 } else myUsername=snap.data().username;
 isDev=DEV_USERS.includes(myUsername);
 initUI();
});

function initUI(){
 document.getElementById("login").style.display="none";
 document.getElementById("app").style.display="flex";
 if(isDev) document.getElementById("devBtn").style.display="block";
 loadChats();
}

async function createChat(){
 let u=prompt("Username to chat with").toLowerCase();
 let chat=await addDoc(collection(db,"chats"),{members:[myUsername,u],name:"Chat"});
 openChat(chat.id);
}

function loadChats(){
 onSnapshot(collection(db,"chats"),snap=>{
  let list=document.getElementById("chatList");
  list.innerHTML="";
  snap.forEach(c=>{
   if(c.data().members.includes(myUsername)){
    let d=document.createElement("div");
    d.className="chatItem";
    d.innerText=c.data().name;
    d.onclick=()=>openChat(c.id);
    list.appendChild(d);
   }
  });
 });
}

function openChat(id){
 currentChat=id;
 let msgBox=document.getElementById("messages");
 msgBox.innerHTML="";
 onSnapshot(query(collection(db,"chats",id,"messages"),orderBy("time")),snap=>{
  msgBox.innerHTML="";
  snap.forEach(m=>{
   let data=m.data();
   let div=document.createElement("div");
   div.className=data.username===myUsername?"me":"other";
   div.innerHTML=`<span class='user'>${data.username}${DEV_USERS.includes(data.username)?" DEV":""}</span>${data.text}`;
   msgBox.appendChild(div);
  });
  msgBox.scrollTop=msgBox.scrollHeight;
 });
}

window.send=async()=>{
 let t=msg.value;
 if(!t) return;
 await addDoc(collection(db,"chats",currentChat,"messages"),{
  text:t,
  username:myUsername,
  time:Date.now()
 });
 msg.value="";
};

window.broadcast=async()=>{
 let t=prompt("Broadcast message");
 let chats=await getDocs(collection(db,"chats"));
 chats.forEach(c=>{
  if(c.data().members.includes(myUsername)){
   addDoc(collection(db,"chats",c.id,"messages"),{
    text:"ðŸ“¢ "+t,
    username:myUsername,
    time:Date.now()
   });
  }
 });
};

</script>

<style>
body{margin:0;font-family:sans-serif;background:#0f172a;color:white}
#app{display:none;height:100vh}
#sidebar{width:30%;background:#111827;padding:10px;overflow:auto}
#chat{flex:1;display:flex;flex-direction:column}
#messages{flex:1;overflow:auto;padding:10px}
.me{background:#2563eb;padding:8px;border-radius:10px;margin:5px;color:white;align-self:flex-end;max-width:70%}
.other{background:#374151;padding:8px;border-radius:10px;margin:5px;color:white;align-self:flex-start;max-width:70%}
.user{display:block;font-size:12px;color:#9ca3af}
#input{display:flex;padding:10px;border-top:1px solid #1f2937}
input{flex:1;padding:10px;border-radius:10px;border:none}
button{background:#2563eb;border:none;color:white;padding:10px;border-radius:8px;margin:4px}
.chatItem{padding:10px;background:#1f2937;margin:5px;border-radius:8px;cursor:pointer}
</style>
</head>

<body>
<div id="login" style="text-align:center;margin-top:100px">
 <h1>Simple Chat</h1>
 <button onclick="login()">Sign in with Google</button>
</div>

<div id="app">
 <div id="sidebar">
  <button onclick="createChat()">âž• Chat</button>
  <button id="devBtn" style="display:none" onclick="broadcast()">DEV Broadcast</button>
  <div id="chatList"></div>
 </div>

 <div id="chat">
  <div id="messages"></div>
  <div id="input">
   <input id="msg" placeholder="Message">
   <button onclick="send()">Send</button>
  </div>
 </div>
</div>
</body>
</html>
